---
import Layout from '../layouts/Layout.astro';
import { NotionLoader } from '../lib/notion-loader';

// Fetch content to display
const loader = new NotionLoader(
  import.meta.env.NOTION_API_KEY,
  import.meta.env.NOTION_DATABASE_ID,
  { cacheImages: true }
);

const allContent = await loader.getAll();

// Extract unique categories for dynamic navigation
const categories = [...new Set(allContent.map(c => c.webCategory).filter(Boolean))].sort();
---

<Layout title="Sabrina's Pause" description="Moments Between ‚Äî A Digital Archive">
  <div class="min-h-screen bg-white">
    
    <!-- Header -->
    <header class="border-b border-neutral-200">
      <div class="max-w-5xl mx-auto px-6 py-16">
        <h1 class="text-6xl font-bold text-neutral-900 mb-4 tracking-tight">
          Sabrina's Pause
        </h1>
        <p class="text-2xl text-neutral-600">
          Moments Between
        </p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto px-6 py-16">
      
      <!-- Filter Navigation - Dynamic from Category tags (M2 Requirement) -->
      {allContent.length > 0 && (
        <div class="flex flex-wrap gap-3 mb-12 pb-6 border-b border-neutral-200">
          <button class="filter-btn active px-4 py-2 rounded-full bg-neutral-900 text-white text-sm font-medium transition-colors" data-filter="all">
            All ({allContent.length})
          </button>
          {categories.map(category => (
            <button class="filter-btn px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 hover:bg-neutral-200 text-sm font-medium transition-colors" data-filter={category.toLowerCase()}>
              {category} ({allContent.filter(c => c.webCategory === category).length})
            </button>
          ))}
        </div>
      )}
      
      {allContent.length === 0 ? (
        <div class="text-center py-20">
          <p class="text-neutral-400 text-lg">No content published yet</p>
        </div>
      ) : (
        <>
          <!-- Content Grid -->
          <div class="grid gap-12 mb-20">
            {allContent.map((content) => {
              // Route to content-type specific pages
              const contentUrl = `/${content.contentType}/${content.slug}`;
              return (
              <article class="group content-item" data-category={content.webCategory.toLowerCase()}>
                <a href={contentUrl} class="block">
                  <div class="flex flex-col md:flex-row gap-8">
                    
                    <!-- Image/Icon Area -->
                    <div class="md:w-1/3 flex-shrink-0">
                      <div class="aspect-[4/3] bg-neutral-100 rounded-lg overflow-hidden group-hover:opacity-90 transition-opacity">
                        {content.heroImage ? (
                          <img 
                            src={content.heroImage} 
                            alt={content.title}
                            class="w-full h-full object-cover"
                          />
                        ) : (
                          <div class="w-full h-full flex items-center justify-center bg-neutral-100">
                            <span class="text-7xl opacity-40">
                              {content.contentType === 'article' ? 'üìÑ' : content.contentType === 'comic' ? 'üé®' : 'üéôÔ∏è'}
                            </span>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <!-- Content Info -->
                    <div class="md:w-2/3">
                      <div class="flex items-center gap-3 mb-3">
                        <span class="text-sm text-neutral-500 font-medium">
                          {content.webCategory}
                        </span>
                        <span class="text-neutral-300">¬∑</span>
                        <span class="text-sm text-neutral-400">{content.date}</span>
                      </div>
                      
                      <h2 class="text-3xl font-bold text-neutral-900 mb-3 group-hover:text-neutral-600 transition-colors">
                        {content.title}
                      </h2>
                      
                      <p class="text-lg text-neutral-600 mb-4 leading-relaxed">
                        {content.intentVector}
                      </p>
                      
                      <div class="flex flex-wrap gap-4 text-sm text-neutral-500 mb-4">
                        <div class="flex items-center gap-2">
                          <span class="font-medium">Location:</span>
                          <span>{content.location.name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="font-medium">SD-Index:</span>
                          <span>{content.sdIndex}/10</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="font-medium">Type:</span>
                          <span class="uppercase text-xs">{content.contentType}</span>
                        </div>
                      </div>
                      
                      {content.project.length > 0 && (
                        <div class="flex gap-2 flex-wrap">
                          {content.project.map((p) => (
                            <span class="text-xs px-3 py-1 bg-neutral-100 text-neutral-700 rounded-full">
                              {p}
                            </span>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </a>
              </article>
            )})}
          </div>
          
          <!-- Pagination Placeholder -->
          <div class="flex justify-center gap-4 py-8 border-t border-neutral-200">
            <span class="px-4 py-2 bg-neutral-900 text-white rounded">1</span>
            <span class="px-4 py-2 text-neutral-400">of 1</span>
          </div>
        </>
      )}

    </main>

    <!-- Footer -->
    <footer class="border-t border-neutral-200 mt-20">
      <div class="max-w-5xl mx-auto px-6 py-12">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
          <div>
            <p class="text-sm text-neutral-900 font-medium mb-2">Sabrina's Pause</p>
            <p class="text-xs text-neutral-500">
              {allContent.length} {allContent.length === 1 ? 'experience' : 'experiences'} ¬∑ AGI-First Architecture
            </p>
          </div>
          <div class="flex gap-6 text-sm">
            <a href="/api/experiences.json" class="text-neutral-500 hover:text-neutral-900 transition-colors">
              JSON API
            </a>
            <a href="/api/schemas.json" class="text-neutral-500 hover:text-neutral-900 transition-colors">
              Schema
            </a>
          </div>
        </div>
      </div>
    </footer>

  </div>
</Layout>

<script>
  function setupFilters() {
    // Content filtering
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.getAttribute('data-filter');
        
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(b => {
          b.classList.remove('active', 'bg-neutral-900', 'text-white');
          b.classList.add('bg-neutral-100', 'text-neutral-700');
        });
        btn.classList.add('active', 'bg-neutral-900', 'text-white');
        btn.classList.remove('bg-neutral-100', 'text-neutral-700');
        
        // Filter content
        document.querySelectorAll('.content-item').forEach(item => {
          if (filter === 'all' || item.getAttribute('data-category') === filter) {
            (item as HTMLElement).style.display = 'block';
          } else {
            (item as HTMLElement).style.display = 'none';
          }
        });
      });
    });
  }

  // Run on initial load and on every page navigation
  document.addEventListener('astro:page-load', setupFilters);
</script>
